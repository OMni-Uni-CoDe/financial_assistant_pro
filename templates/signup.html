{% extends "base.html" %}
{% block content %}
<div class="login-container">
    <h2>Create Account</h2>
    <form id="signupForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" id="username" name="username" placeholder="Username (letters+numbers)" required><br>
        <small id="userHelp"></small><br>
        <input type="email" id="email" name="email" placeholder="Email (optional)"><br>
        <input type="password" id="password" name="password" placeholder="Password" required><br>
        <meter id="pwMeter" min="0" max="4" low="2"></meter><br>
        <small id="pwHelp">Use 8+ chars, upper, lower, number, special.</small><br>
        <button type="submit">Sign Up</button>
    </form>
    <p>Already have an account? <a href="/login">Login</a></p>
</div>


<script>
    const userInput = document.getElementById('username');
    const userHelp = document.getElementById('userHelp');
    const pwInput = document.getElementById('password');
    const pwMeter = document.getElementById('pwMeter');
    const pwHelp = document.getElementById('pwHelp');


    let checkTimeout;
    userInput.addEventListener('input', () => {
        clearTimeout(checkTimeout);
        const val = userInput.value.trim();
        if (!val) { userHelp.innerText = ''; return; }
        checkTimeout = setTimeout(async () => {
            try {
                const res = await fetch('/check_username?username=' + encodeURIComponent(val));
                const data = await res.json();
                userHelp.innerText = data.available ? '✓ Username available' : '✖ Username taken';
            } catch (e) {
                userHelp.innerText = '';
            }
        }, 400);
    });


    pwInput.addEventListener('input', () => {
        const v = pwInput.value;
        let score = 0;
        if (v.length >= 8) score++;
        if (/[A-Z]/.test(v)) score++;
        if (/[a-z]/.test(v)) score++;
        if (/\d/.test(v)) score++;
        if (/[^A-Za-z0-9]/.test(v)) score++;
        pwMeter.value = Math.min(4, score);
        pwHelp.innerText = score >= 4 ? 'Strong password' : 'Weak password';
    });


    document.getElementById('signupForm').addEventListener('submit', (e) => {
        if (pwMeter.value < 4) {
            e.preventDefault();
            alert('Make your password stronger.');
        }
    });
</script>
{% endblock %}